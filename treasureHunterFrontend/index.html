<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Friday Kick-Out Competition!</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="assets/styles/bootstrap.min.css">
		<link rel="stylesheet" href="assets/styles/style.css">
		<script src="assets/scripts/jquery.min.js"></script>
		<script src="assets/scripts/bootstrap.min.js"></script>

		<script>
			$(function() {
				// Document is ready
				updateScoreboard();
				setInterval(updateScoreboard, 3000);
			});

			var emptyImage = $('<img />').prop('src', '/assets/img/empty.png');
			var treasureImage = $('<img />').prop('src', '/assets/img/chest.png');
			var wallImage = $('<img />').prop('src', '/assets/img/wall.png');
			var redUpImage = $('<img />').prop('src', '/assets/img/imp_red_up.png');
			var redDownImage = $('<img />').prop('src', '/assets/img/imp_red_down.png');
			var redLeftImage = $('<img >').prop('src', '/assets/img/imp_red_left.png');
			var redRightImage = $('<img >').prop('src', '/assets/img/imp_red_right.png');
			var yellowUpImage = $('<img >').prop('src', '/assets/img/imp_yellow_up.png');
			var yellowDownImage = $('<img >').prop('src', '/assets/img/imp_yellow_down.png');
			var yellowLeftImage = $('<img >').prop('src', '/assets/img/imp_yellow_left.png');
			var yellowRightImage = $('<img >').prop('src', '/assets/img/imp_yellow_right.png');

			function imgLoaded() {
				if (imagesLoaded >= 11) {			var currentReplay;
					console.log('All images have finished loading!');
				}			var imagesLoaded = 0;
			};		
		                                                              		
			emptyImage.load(imgLoaded);		
			treasureImage.load(imgLoaded);		
			wallImage.load(imgLoaded);		
			redUpImage.load(imgLoaded);
			redDownImage.load(imgLoaded);		
			redLeftImage.load(imgLoaded);		
			redRightImage.load(imgLoaded);		
			yellowUpImage.load(imgLoaded);		
			yellowDownImage.load(imgLoaded);		
			yellowLeftImage.load(imgLoaded);		
			yellowRightImage.load(imgLoaded);		

			var imgs = {
				"EMPTY": emptyImage,
				"TREASURE": treasureImage,
				"WALL": wallImage,
				"RED_UP": redUpImage,
				"RED_DOWN": redDownImage,
				"RED_LEFT": redLeftImage,
				"RED_RIGHT": redRightImage,
				"YELLOW_UP": yellowUpImage,
				"YELLOW_DOWN": yellowDownImage,
				"YELLOW_LEFT": yellowLeftImage,
				"YELLOW_RIGHT": yellowRightImage
			}

			var currentFrameShowing = 0;
			var currentMatchShowing = '';
			var gameSummaries = {};

			var playedGames = fromJSON(localStorage.getItem('playedGames'));
			if (playedGames == null) playedGames = {};


			function updateScoreboard() {
				if (currentMatchShowing != '') {
					return;
				}

				$.getJSON ("//localhost:8080/treasureHunterGameSummary.json", function(gameSummary) {
					$('.table tr').remove();

					var headerRow = buildHeader(gameSummary);
					var contentRow;

					for (var game in gameSummary) {
						 contentRow = $('<tr>');

						if (gameSummaries[gameSummary[game['uuid']]] != undefined) {
							return;
						}

						if (playedGames[gameSummary[game]['uuid']] == undefined) {
							// This is an unplayed game. Add a play button.
							gameSummaries[gameSummary[game]['uuid']] = gameSummary[game];

							var value = '<input type="hidden" value="' + gameSummary[game]["uuid"] + '">'
					 		var playButton = '<input type="button" value="Play"></input>';

							contentRow.append($('<td colspan="12">').html(value + playButton));
							contentRow.find('input[type=button]').click(playGame);

							$('.table tbody').append(contentRow);

							continue;
						}

						for (var data in gameSummary[game]) {
							var value = gameSummary[game][data];

							if (data === 'playerMoves') {
								value = '<input type="button" value="Replay match">';
							}
							else if (data === 'boardStates') {
								gameSummaries[gameSummary[game]['uuid']] = gameSummary[game];
								value = '<input type="button" value="Replay match">';
							}
							else if (data === 'redPlayerGameTime' || data === 'yellowPlayerGameTime') {
								value /= 1000.0;
							}
							else if (/*data === 'redPlayerGameTime' || data === 'yellowPlayerGameTime' ||*/ data === 'uuid') {
								value = '<input type="hidden" value="' + gameSummary[game]["uuid"] + '">'
							}
							contentRow.append($('<td>').html(value));
						}

						contentRow.find('input[type=button]').click(playGame);
						$('.table tbody').append(contentRow);
					}

					$('.table thead').append(headerRow);
					$(".table tbody").each(function(elem,index){
						  var arr = $.makeArray($("tr",this).detach());
						  arr.reverse();
						  $(this).append(arr);
					});

				});
			}

			function buildHeader(games) {
				var headerRow = $('<tr>');
				var translationTable = {
					'redPlayerName': 'Player Red',
					'redPlayerTreasures' : 'Red score',
					'redPlayerGameTime': 'Red computation time',
					'yellowPlayerName': 'Player Yellow',
					'yellowPlayerTreasures' : 'Yellow score',
					'yellowPlayerGameTime': 'Yellow computation time',
					'totalTreasures': 'Total treasures',
					'gameName': 'Name of the Game',
					'playerMoves': 'Replay',
					'draws': 'Draws',
					'redWins': 'Red victories',
					'yellowWins': 'Yellow victories',
					'boardState': '',
					'gameStartDate': 'Battle took place',
					'uuid': ''
				};

				for (var data in firstGame = games[0]) {
					headerRow.append($('<th>').text(translationTable[data]));
				}
				return headerRow;
			}

			function playGame(e) {
				var currentRow = $(this).closest('tr');
				var uuid = currentRow.find('input[type=hidden]').val();
				var result = gameSummaries[uuid]['boardStates'];

				var resultRow = $('<tr class="result-row">');
				var resultCell = $('<td colspan="12">');

				// Set up canvas
				var numColumns = result[0].length;
				var numRows = result[0][0].length;

				var canvas = $('<canvas id="currentGameCanvas"></canvas>');
				canvas.prop('width', numColumns * 32);
				canvas.prop('height', numRows * 32);

				currentRow.after(resultRow.append(resultCell.append(canvas)));

				currentMatchShowing = uuid;

				currentReplay = setInterval(function() {
					drawNextFrame();
				}, 80);
			}

			function drawNextFrame() {
				var rounds = gameSummaries[currentMatchShowing]['boardStates'];

				if (currentFrameShowing >= rounds.length) {
					endPreview();
					return;
				}

				var columnLength = rounds[0].length;
				var rowLength = rounds[0][0].length;

				var gameField = $('#currentGameCanvas');
				var context = gameField[0].getContext('2d');

				// Clear screen before drawing
				context.clearRect(0, 0, gameField.width(), gameField.height());

				for (var row = 0; row < rowLength; row++) {
					for (var column = 0; column < columnLength; column++) {
						var state = rounds[currentFrameShowing][column][row];
						var img;
						img = imgs[state][0];

						context.drawImage(img, column * img.width, row * img.height);
					}
				}

				currentFrameShowing++;
			}

			function endPreview() {
				clearInterval(currentReplay);

				var newPlayedGames = fromJSON(localStorage.getItem('playedGames'));
				if (newPlayedGames == null) newPlayedGames = {};

				newPlayedGames[currentMatchShowing] = 'PLAYED';
				localStorage.setItem('playedGames', toJSON(newPlayedGames));

				playedGames = fromJSON(localStorage.getItem('playedGames'));
				currentMatchShowing = '';
				currentFrameShowing = 0;
				updateScoreboard();

				$('.result-row').remove();
			}

			function fromJSON(jsonString) {
				return JSON.parse(jsonString);
			}

			function toJSON(item) {
				return JSON.stringify(item);
			}
		</script>
	</head>
	<body>
		<div class="container">
			<div class="row" style>
				<div class='col-md-4 hidden-xs hidden-sm hidden-md' >
					<img style="height: 120px; float: right;" src="/assets/img/TorchPillarFlaming.gif" alt="Olympic Robocop flame.">
				</div>
				<div class='col-md-4' style="text-align: center">
					<h2>Treasure Hunter scoreboard</h2>
				</div>
				<div class='col-md-4 hidden-xs hidden-sm hidden-md'>
					 <img style="height: 120px; float: left;" src="/assets/img/TorchPillarFlaming.gif" alt="Olympic Robocop flame.">
				</div>
			</div>
			<p style="text-align: center">This is the current scoreboard over the played games:</p>
			<div id='dummy'> </div>
			<table class="table">
				<thead></thead>
				<tbody></tbody>
			</table>
		</div>
	</body>
</html>
